var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");require("core-js/modules/es.string.trim");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _react=_interopRequireWildcard(require("react"));var _emotionTheming=require("emotion-theming");var _addons=_interopRequireDefault(require("@storybook/addons"));var _coreEvents=_interopRequireDefault(require("@storybook/core-events"));var _channels=_interopRequireDefault(require("@storybook/channels"));var _channelWebsocket=_interopRequireDefault(require("@storybook/channel-websocket"));var _clientApi=require("@storybook/client-api");var _OnDeviceUI=_interopRequireDefault(require("./components/OnDeviceUI"));var _StoryView=_interopRequireDefault(require("./components/StoryView"));var _theme=require("./components/Shared/theme");var _rnHostDetect=_interopRequireDefault(require("./rn-host-detect"));var _jsxFileName="/Users/shilman/projects/baseline/storybook/app/react-native/src/preview/index.tsx";var STORAGE_KEY='lastOpenedStory';var Preview=function(){function Preview(){var _this=this;(0,_classCallCheck2["default"])(this,Preview);this._clientApi=void 0;this._stories=void 0;this._addons=void 0;this._decorators=void 0;this._asyncStorageStoryId=void 0;this._asyncStorage=void 0;this.api=function(){return _this._clientApi;};this.configure=function(loadStories,module){loadStories();if(module&&module.hot){module.hot.accept(function(){return _this._sendSetStories();});}};this.getStorybookUI=function(){var params=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var webUrl=null;var channel=null;if(params.asyncStorage===undefined){console.warn("\nStarting Storybook v5.3.0, we require to manually pass an asyncStorage prop. Pass null to disable or use one from @react-native-community or react-native itself.\n\nMore info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#react-native-async-storage\n      ".trim());}if(params.asyncStorage){_this._asyncStorage=params.asyncStorage;}var onDeviceUI=params.onDeviceUI!==false;var initialSelection=params.initialSelection,shouldPersistSelection=params.shouldPersistSelection;try{channel=_addons["default"].getChannel();}catch(e){}if(!channel||params.resetStorybook){if(onDeviceUI&&params.disableWebsockets){channel=new _channels["default"]({async:true});_this._setInitialStory(initialSelection,shouldPersistSelection);}else{var host=(0,_rnHostDetect["default"])(params.host||'localhost');var port=":"+(params.port||7007);var query=params.query||'';var secured=params.secured;var websocketType=secured?'wss':'ws';var httpType=secured?'https':'http';var url=websocketType+"://"+host+port+"/"+query;webUrl=httpType+"://"+host+port;channel=(0,_channelWebsocket["default"])({url:url,async:onDeviceUI,onError:function onError(){_this._setInitialStory(initialSelection,shouldPersistSelection);}});}_addons["default"].setChannel(channel);_this._stories.setChannel(channel);channel.emit(_coreEvents["default"].CHANNEL_CREATED);}channel.on(_coreEvents["default"].GET_STORIES,function(){return _this._sendSetStories();});channel.on(_coreEvents["default"].SET_CURRENT_STORY,function(d){return _this._selectStoryEvent(d);});_this._sendSetStories();var preview=_this;_addons["default"].loadAddons(_this._clientApi);var appliedTheme=(0,_extends2["default"])({},_theme.theme,{},params.theme);return function(_PureComponent){(0,_inherits2["default"])(StorybookRoot,_PureComponent);function StorybookRoot(){(0,_classCallCheck2["default"])(this,StorybookRoot);return(0,_possibleConstructorReturn2["default"])(this,(0,_getPrototypeOf2["default"])(StorybookRoot).apply(this,arguments));}(0,_createClass2["default"])(StorybookRoot,[{key:"render",value:function render(){if(onDeviceUI){return _react["default"].createElement(_emotionTheming.ThemeProvider,{theme:appliedTheme,__source:{fileName:_jsxFileName,lineNumber:147}},_react["default"].createElement(_OnDeviceUI["default"],{stories:preview._stories,url:webUrl,isUIHidden:params.isUIHidden,tabOpen:params.tabOpen,shouldDisableKeyboardAvoidingView:params.shouldDisableKeyboardAvoidingView,keyboardAvoidingViewVerticalOffset:params.keyboardAvoidingViewVerticalOffset,__source:{fileName:_jsxFileName,lineNumber:148}}));}return _react["default"].createElement(_emotionTheming.ThemeProvider,{theme:appliedTheme,__source:{fileName:_jsxFileName,lineNumber:161}},_react["default"].createElement(_StoryView["default"],{stories:preview._stories,url:webUrl,__source:{fileName:_jsxFileName,lineNumber:162}}));}}]);return StorybookRoot;}(_react.PureComponent);};this._setInitialStory=function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(initialSelection){var shouldPersistSelection,story,_args=arguments;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:shouldPersistSelection=_args.length>1&&_args[1]!==undefined?_args[1]:true;_context.next=3;return _this._getInitialStory(initialSelection,shouldPersistSelection)();case 3:story=_context.sent;if(story){_this._selectStory(story);}case 5:case"end":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();this._getInitialStory=function(initialSelection){var shouldPersistSelection=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(){var story,_value,stories;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:story=null;if(!(initialSelection&&_this._checkStory(initialSelection))){_context2.next=5;break;}story=initialSelection;_context2.next=20;break;case 5:if(!shouldPersistSelection){_context2.next=20;break;}_context2.prev=6;_value=_this._asyncStorageStoryId;if(!(!_value&&_this._asyncStorage)){_context2.next=15;break;}_context2.t0=JSON;_context2.next=12;return _this._asyncStorage.getItem(STORAGE_KEY);case 12:_context2.t1=_context2.sent;_value=_context2.t0.parse.call(_context2.t0,_context2.t1);_this._asyncStorageStoryId=_value;case 15:if(_this._checkStory(_value)){story=_value;}_context2.next=20;break;case 18:_context2.prev=18;_context2.t2=_context2["catch"](6);case 20:if(!story){_context2.next=22;break;}return _context2.abrupt("return",_this._getStory(story));case 22:stories=_this._stories.raw();if(!(stories&&stories.length)){_context2.next=25;break;}return _context2.abrupt("return",_this._getStory(stories[0].id));case 25:return _context2.abrupt("return",null);case 26:case"end":return _context2.stop();}}},_callee2,null,[[6,18]]);}));};this._addons={};this._decorators=[];this._stories=new _clientApi.StoryStore({channel:null});this._clientApi=new _clientApi.ClientApi({storyStore:this._stories});}(0,_createClass2["default"])(Preview,[{key:"_sendSetStories",value:function _sendSetStories(){var channel=_addons["default"].getChannel();var stories=this._stories.extract();channel.emit(_coreEvents["default"].SET_STORIES,{stories:stories});channel.emit(_coreEvents["default"].STORIES_CONFIGURED);}},{key:"_getStory",value:function _getStory(storyId){return this._stories.fromId(storyId);}},{key:"_selectStoryEvent",value:function _selectStoryEvent(_ref3){var storyId=_ref3.storyId;if(storyId){if(this._asyncStorage){this._asyncStorage.setItem(STORAGE_KEY,JSON.stringify(storyId))["catch"](function(){});}var story=this._getStory(storyId);this._selectStory(story);}}},{key:"_selectStory",value:function _selectStory(story){var channel=_addons["default"].getChannel();this._stories.setSelection({storyId:story.id,viewMode:'story'},null);channel.emit(_coreEvents["default"].SELECT_STORY,story);}},{key:"_checkStory",value:function _checkStory(storyId){if(!storyId){return null;}var story=this._getStory(storyId);if(story.storyFn===null){return null;}return story;}}]);return Preview;}();exports["default"]=Preview;